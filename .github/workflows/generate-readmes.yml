name: üñºÔ∏è Auto-Generate Directory Readmes

on:
  push:
    branches:
      - review
    # Triggers on code changes, but ignores changes to existing text files to prevent infinite loops.
    paths-ignore:
      - '**.md'  
      - '**.txt' 
    
  workflow_dispatch:
    # Allows manual runs.

jobs:
  generate_readmes:
    runs-on: ubuntu-latest
    
    # Restricts manual runs to branches other than 'main' and 'final'.
    if: |
      github.event_name != 'workflow_dispatch' || (
        github.event_name == 'workflow_dispatch' && 
        github.ref != 'refs/heads/main' &&
        github.ref != 'refs/heads/final'
      )
      
    permissions:
      contents: write # Crucial permission needed for pushing commits
      
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
        with:
          # Use the built-in token for authentication
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: ‚öôÔ∏è Run README Generation Script
        run: python generate_readmes.py
        
      # -----------------------------------------------------------------
      # CORRECTED AND ROBUST GIT COMMIT AND PUSH STEP
      # This addresses the 'nothing to commit' error by fixing the git add command.
      # -----------------------------------------------------------------
      - name: ‚¨ÜÔ∏è Explicitly Commit and Push Generated READMEs (FIXED)
        id: commit_push
        run: |
          # 1. Check status (for initial debugging)
          echo "--- Checking Git Status BEFORE Commit ---"
          git status
          
          # 2. Configure Git user for the commit
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 3. CRITICAL FIX: Use Git's native pathspec to reliably stage files recursively.
          # The previous '**/README.md' failed because the shell didn't expand it correctly.
          git add --force . ':(glob)**/README.md'
          
          # 4. Check status again (to CONFIRM files are staged)
          echo "--- Checking Git Status AFTER ADD (Should show Staged Changes) ---"
          git status
          
          # 5. Commit ONLY if there are staged changes
          if git commit --dry-run --allow-empty --message "CI: Auto-generated image thumbnail README.md files" ; then
            echo "Changes detected and staged. Committing..."
            git commit --message "CI: Auto-generated image thumbnail README.md files"
            
            # 6. Push the changes to the current branch (e.g., 'review')
            echo "Pushing changes back to the remote repository..."
            git push origin ${{ github.ref_name }}
          else
            echo "No changes detected after 'git add'. Skipping commit."
          fi
